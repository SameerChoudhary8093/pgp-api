generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Loksabha {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  vidhansabhas Vidhansabha[]
}

model Vidhansabha {
  id         Int         @id @default(autoincrement())
  name       String
  loksabhaId Int
  elections  Election[]
  localUnits LocalUnit[]
  loksabha   Loksabha    @relation(fields: [loksabhaId], references: [id])

  @@unique([loksabhaId, name], name: "loksabhaId_name")
  @@index([loksabhaId])
}

model LocalUnit {
  id            Int           @id @default(autoincrement())
  vidhansabhaId Int
  name          String
  type          LocalUnitType
  committees    Committee[]
  vidhansabha   Vidhansabha   @relation(fields: [vidhansabhaId], references: [id])
  users         User[]

  @@unique([vidhansabhaId, name, type], name: "vidhansabhaId_name_type")
  @@index([vidhansabhaId, type])
}

model District {
  id   Int             @id @default(autoincrement())
  name String          @unique
  gps  GramPanchayat[]
}

model GramPanchayat {
  id         Int      @id @default(autoincrement())
  name       String
  districtId Int
  district   District @relation(fields: [districtId], references: [id])
  wards      Ward[]

  @@unique([districtId, name])
  @@index([districtId])
}

model Ward {
  id         Int           @id @default(autoincrement())
  wardNumber Int
  gpId       Int
  gp         GramPanchayat @relation(fields: [gpId], references: [id])

  @@unique([gpId, wardNumber])
}

model User {
  id                   Int                @id @default(autoincrement())
  name                 String
  phone                String             @unique
  passwordHash         String
  address              String
  wardId               Int?
  role                 Role               @default(CWC)
  referralCode         String             @unique
  referredByUserId     Int?
  isActive             Boolean            @default(true)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  authUserId           String?            @unique
  memberId             String?            @unique
  photoUrl             String?
  localUnitId          Int?
  auditLogs            AuditLog[]         @relation("AuditActor")
  ballotSubmissions    BallotSubmission[]
  candidates           Candidate[]
  committeeMemberships CommitteeMember[]
  localUnit            LocalUnit?         @relation(fields: [localUnitId], references: [id])
  referredBy           User?              @relation("UserReferrals", fields: [referredByUserId], references: [id])
  recruits             User[]             @relation("UserReferrals")
  receivedVotes        Vote[]             @relation("CandidateVotes")
  votes                Vote[]             @relation("UserVotes")

  @@index([referredByUserId])
  @@index([role])
  @@index([wardId])
  @@index([localUnitId])
}

model Election {
  id                Int                @id @default(autoincrement())
  councilLevel      CouncilLevel
  position          String             @default("President")
  status            ElectionStatus     @default(Active)
  openedAt          DateTime?          @default(now())
  closedAt          DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  districtId        Int?
  vidhansabhaId     Int?
  ballotSubmissions BallotSubmission[]
  candidates        Candidate[]
  vidhansabha       Vidhansabha?       @relation(fields: [vidhansabhaId], references: [id])
  votes             Vote[]

  @@index([districtId])
  @@index([vidhansabhaId])
}

model Candidate {
  id         Int      @id @default(autoincrement())
  electionId Int
  userId     Int
  election   Election @relation(fields: [electionId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([electionId, userId])
}

model Vote {
  id              Int      @id @default(autoincrement())
  electionId      Int
  voterUserId     Int
  candidateUserId Int
  createdAt       DateTime @default(now())
  candidate       User     @relation("CandidateVotes", fields: [candidateUserId], references: [id])
  election        Election @relation(fields: [electionId], references: [id])
  voter           User     @relation("UserVotes", fields: [voterUserId], references: [id])

  @@unique([electionId, voterUserId, candidateUserId])
}

model BallotSubmission {
  id          Int      @id @default(autoincrement())
  electionId  Int
  voterUserId Int
  createdAt   DateTime @default(now())
  election    Election @relation(fields: [electionId], references: [id])
  voter       User     @relation(fields: [voterUserId], references: [id])

  @@unique([electionId, voterUserId])
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  actorUserId Int?
  action      String
  entityType  String
  entityId    String
  reason      String?
  metadata    Json?
  createdAt   DateTime @default(now())
  actor       User?    @relation("AuditActor", fields: [actorUserId], references: [id])

  @@index([actorUserId])
}

model Committee {
  id          Int               @id @default(autoincrement())
  name        String
  type        CommitteeType
  localUnitId Int
  localUnit   LocalUnit         @relation(fields: [localUnitId], references: [id])
  members     CommitteeMember[]

  @@unique([name, localUnitId, type])
  @@index([localUnitId])
}

model CommitteeMember {
  userId      Int
  committeeId Int
  role        Role?
  isPresident Boolean   @default(false)
  createdAt   DateTime  @default(now())
  committee   Committee @relation(fields: [committeeId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@id([userId, committeeId])
  @@index([committeeId])
}

enum Role {
  Admin
  Founder
  SSP
  PPC
  APC
  CWC
  Worker
  CWCPresident
  CWCMember
  ExtendedMember
}

enum CouncilLevel {
  CWC
  ALC
  SLC
  APC
}

enum ElectionStatus {
  Active
  Closed
}

enum LocalUnitType {
  Ward
  GramPanchayat
}

enum CommitteeType {
  CWC
  APC
  PPC
  SSP
}
